# 天地图 H5 半屏地图应用

基于天地图 JavaScript API 构建的 H5 半屏地图应用，支持地点检索、路线规划和用户定位功能。

## 功能特性

### 1. 地点检索
- **行政区划选择**：支持选择行政区（省/市），自动定位到行政区中心点
- **关键字搜索**：根据关键字实时搜索 POI 地点
- **实时候选列表**：输入关键字时自动显示候选列表（最多10条）
- **完整地址显示**：点击标记点显示完整地址信息（省市区+详细地址+坐标）

### 2. 路线规划
- **多用户路线**：支持用户A和用户B的起点终点规划
- **公路路线**：使用天地图驾车服务规划实际道路路线
- **空运路线**：显示起点到终点的直线距离
- **可视化标记**：不同颜色区分用户A/B的起终点

### 3. 用户定位
- **一次性定位**：获取用户当前位置一次
- **连续定位**：实时跟踪用户位置变化
- **动态标记**：在地图上显示用户当前位置标记

## 技术栈

- **前端框架**：原生 JavaScript (ES5)
- **地图服务**：天地图 JavaScript API v4.0
- **后端代理**：Node.js + Express（解决 CORS 和 403 问题）
- **HTTP 客户端**：Fetch API / JSONP

## 项目结构

```
tdt/
├── index.html              # 主页面文件
├── proxy-server.js         # 服务端代理服务器
├── package.json            # Node.js 依赖配置
├── .gitignore              # Git 忽略文件
└── README.md               # 项目说明文档
```

## 快速开始

### 前置要求

- Node.js >= 14.0.0
- 天地图 API Key（在 [天地图开放平台](https://lbs.tianditu.gov.cn/) 申请）

### 安装步骤

1. **克隆或下载项目**
   ```bash
   cd tdt
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **配置天地图 API Key**
   
   打开 `index.html`，找到第7行，将 `YOUR_TDT_KEY` 替换为你的天地图 API Key：
   ```html
   <script src="https://api.tianditu.gov.cn/api?v=4.0&tk=你的API密钥"></script>
   ```

4. **启动代理服务器**
   ```bash
   node proxy-server.js
   ```
   
   服务器将在 `http://localhost:3000` 启动

5. **打开前端页面**
   
   使用浏览器打开 `index.html`，或使用本地服务器：
   ```bash
   # 使用 Python
   python -m http.server 8000
   
   # 使用 Node.js http-server
   npx http-server -p 8000
   ```
   
   然后访问 `http://localhost:8000`

## 配置说明

### 代理服务器配置

如果前端和代理服务器不在同一域名，需要修改 `index.html` 中的代理地址：

```javascript
// 第408行左右
var TDT_SEARCH_API = "http://localhost:3000/api/tdt-search";
```

### 行政区划配置

在 `index.html` 中的 `ADMIN_REGIONS` 数组中添加更多行政区：

```javascript
var ADMIN_REGIONS = [
  { name: "北京市", code: "156110000", center: { lng: 116.407395, lat: 39.904211, zoom: 11 } },
  // 添加更多行政区...
];
```

## API 接口

### 地点检索接口

使用天地图 v2/search 接口进行地点检索：

- **接口地址**：`https://api.tianditu.gov.cn/v2/search`
- **请求方式**：GET（通过服务端代理）
- **参数说明**：
  - `keyWord`: 搜索关键字（必填）
  - `specify`: 行政区划国标码（必填，9位）
  - `queryType`: 查询类型，固定为 "12"
  - `start`: 起始位置（0-300）
  - `count`: 返回数量（1-300）

## 使用示例

### 地点检索

1. 在下拉框中选择行政区（如：北京市）
2. 在搜索框输入关键字（如：天安门）
3. 点击"检索"按钮或从候选列表中选择
4. 地图上会显示检索结果标记
5. 点击标记查看完整地址和坐标

### 路线规划

1. 输入用户A的起点终点坐标
2. 输入用户B的起点终点坐标
3. 选择路线类型（公路路线/空运路线）
4. 点击"规划路线"按钮
5. 地图上会显示路线和起终点标记

### 用户定位

1. 点击"获取一次定位"获取当前位置
2. 或点击"开启连续定位"实时跟踪位置
3. 地图上会显示紫色位置标记

## 注意事项

1. **API Key 配置**：必须配置有效的天地图 API Key，否则地图无法加载
2. **代理服务器**：必须启动代理服务器，否则地点检索会返回 403 错误
3. **HTTPS 要求**：用户定位功能需要在 HTTPS 或 localhost 环境下使用
4. **浏览器兼容性**：建议使用现代浏览器（Chrome、Firefox、Edge 等）

## 常见问题

### Q: 地图无法加载？
A: 检查 API Key 是否正确配置，网络是否正常。

### Q: 地点检索返回 403？
A: 确保代理服务器已启动，检查 `TDT_SEARCH_API` 配置是否正确。

### Q: 用户定位无法使用？
A: 确保在 HTTPS 或 localhost 环境下，浏览器已授权位置访问权限。

## 开发说明

### 代码结构

- **全局变量**：地图实例、服务实例、标记数组等
- **工具函数**：日志记录、坐标解析、地址构建等
- **核心功能**：地图初始化、地点检索、路线规划、用户定位

### 扩展开发

- 添加更多行政区划：修改 `ADMIN_REGIONS` 数组
- 自定义地图样式：修改地图初始化参数
- 添加更多功能：参考现有代码结构添加新功能模块

## 许可证

MIT License

## 关键字

天地图, 地图应用, H5地图, 地点检索, POI搜索, 路线规划, 驾车路线, 用户定位, Geolocation, 行政区划, 国标码, 坐标显示, 半屏地图, JavaScript, Node.js, Express, 代理服务器, CORS, JSONP, 天地图API, 地图标记, 信息窗口

## 作者

geiwoaichide

## 更新日志

### v1.0.0
- 初始版本发布
- 实现地点检索功能
- 实现路线规划功能
- 实现用户定位功能
- 添加服务端代理支持

